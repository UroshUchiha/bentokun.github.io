<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>AudioStreamEngine.cpp Source File</title>
<link href="style.css" rel="stylesheet" type="text/css">
</head>

<table border="0" width="100%" height="8" bgcolor="#eeeeee">
<tr> <td width="100%" height="1"><b><font size="2" color="#000000" face="Arial, Helvetica, sans-serif"><strong><a name=Top></a>
S60 5th Edition SDK </strong></font></b><br><i>Example Applications Guide</i></td></tr> </table>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<h1>AudioStreamEngine.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">* ==============================================================================</span>
<a name="l00003"></a>00003 <span class="comment">*  Name        : AudioStreamEngine.cpp</span>
<a name="l00004"></a>00004 <span class="comment">*  Part of     : AudioStream</span>
<a name="l00005"></a>00005 <span class="comment">*  Created     : April 28, 2006 by Forum Nokia</span>
<a name="l00006"></a>00006 <span class="comment">*  Description : </span>
<a name="l00007"></a>00007 <span class="comment">*  Version     : 2.0</span>
<a name="l00008"></a>00008 <span class="comment">*</span>
<a name="l00009"></a>00009 <span class="comment">*  Copyright (c) 2006 - 2007 Nokia Corporation.</span>
<a name="l00010"></a>00010 <span class="comment">*  This material, including documentation and any related</span>
<a name="l00011"></a>00011 <span class="comment">*  computer programs, is protected by copyright controlled by</span>
<a name="l00012"></a>00012 <span class="comment">*  Nokia Corporation.</span>
<a name="l00013"></a>00013 <span class="comment">* ==============================================================================</span>
<a name="l00014"></a>00014 <span class="comment">*/</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;mda\common\audio.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;mmf\common\mmfutilities.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;MdaAudioInputStream.h&gt;</span>        <span class="comment">// audio input stream</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;MdaAudioOutputStream.h&gt;</span>       <span class="comment">// audio output stream</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;s32file.h&gt;</span>                            <span class="comment">// RFileWriteStream and RFileReadStream</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include "AudioStreamEngine.h"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "audiostream.pan"</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">// Audio data buffer size.</span>
<a name="l00026"></a>00026 <span class="comment">// In both 3rd Edition and 2nd Edition the total buffer (iStreamBuffer) size is </span>
<a name="l00027"></a>00027 <span class="comment">// KFrameSizePCM * KFrameCountPCM = 40960 bytes. This will contain 2560 ms </span>
<a name="l00028"></a>00028 <span class="comment">// of 16-bit audio data. </span>
<a name="l00029"></a>00029 <span class="comment">// In 3rd Edition the KFrameSizePCM is 4096 bytes, because CMdaAudioInputStream::ReadL() </span>
<a name="l00030"></a>00030 <span class="comment">// returns audio data in 4096-byte chunks. In 2nd Edition, ReadL() returns data in 320-byte</span>
<a name="l00031"></a>00031 <span class="comment">// chunks.</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#ifdef __SERIES60_3X__  // 3rd Edition</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="keyword">const</span> TInt KFrameSizePCM = 4096;
<a name="l00035"></a>00035 <span class="keyword">const</span> TInt KFrameCountPCM = 10;
<a name="l00036"></a>00036 <span class="preprocessor">#else // 2nd Edition</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="keyword">const</span> TInt KFrameSizePCM = 320;
<a name="l00038"></a>00038 <span class="keyword">const</span> TInt KFrameCountPCM = 128;
<a name="l00039"></a>00039 <span class="preprocessor">#endif</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="comment">// Audio data buffer size for AMR encoding. For AMR, the buffer size is the same in</span>
<a name="l00042"></a>00042 <span class="comment">// both 2nd and 3rd Edition devices (20 ms per frame, a total of 2560 ms in 128 frames).</span>
<a name="l00043"></a>00043 <span class="keyword">const</span> TInt KFrameSizeAMR = 14;
<a name="l00044"></a>00044 <span class="keyword">const</span> TInt KFrameCountAMR = 128;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// Header data for an AMR-encoded audio file</span>
<a name="l00047"></a>00047 <span class="keyword">const</span> TInt KAMRHeaderLength=6;
<a name="l00048"></a>00048 <span class="keyword">const</span> TUint8 KAMRNBHeader[KAMRHeaderLength] = { 0x23, 0x21, 0x41, 0x4d, 0x52, 0x0a };
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">// Files to store the sample audio clips</span>
<a name="l00051"></a>00051 _LIT(KAudioFilePCM, <span class="stringliteral">"sample.aud"</span>);
<a name="l00052"></a>00052 _LIT(KAudioFileAMR, <span class="stringliteral">"sample.amr"</span>);
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#ifdef __WINS__</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="comment">// The path to the sample files in 2nd Ed emulator</span>
<a name="l00056"></a>00056 _LIT(KEmulatorPath, <span class="stringliteral">"c:\\system\\apps\\audiostream\\"</span>);
<a name="l00057"></a>00057 <span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a><a class="code" href="class_c_audio_stream_engine.html#576685510eb4e672aab11db75f982f33">00059</a> <a class="code" href="class_c_audio_stream_engine.html">CAudioStreamEngine</a>* <a class="code" href="class_c_audio_stream_engine.html#576685510eb4e672aab11db75f982f33">CAudioStreamEngine::NewL</a>(<a class="code" href="class_c_audio_stream_app_ui.html">CAudioStreamAppUi</a>* aAppUi)
<a name="l00060"></a>00060         {
<a name="l00061"></a>00061         <a class="code" href="class_c_audio_stream_engine.html">CAudioStreamEngine</a>* <span class="keyword">self</span> = <a class="code" href="class_c_audio_stream_engine.html#540fd788b44eabfcde5e17263d4251ab">CAudioStreamEngine::NewLC</a>(aAppUi);
<a name="l00062"></a>00062     CleanupStack::Pop(<span class="keyword">self</span>);
<a name="l00063"></a>00063         <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="class_c_audio_stream_engine.html#540fd788b44eabfcde5e17263d4251ab">00066</a> <a class="code" href="class_c_audio_stream_engine.html">CAudioStreamEngine</a>* <a class="code" href="class_c_audio_stream_engine.html#540fd788b44eabfcde5e17263d4251ab">CAudioStreamEngine::NewLC</a>(<a class="code" href="class_c_audio_stream_app_ui.html">CAudioStreamAppUi</a>* aAppUi)
<a name="l00067"></a>00067         {
<a name="l00068"></a>00068         <a class="code" href="class_c_audio_stream_engine.html">CAudioStreamEngine</a>* <span class="keyword">self</span> = <span class="keyword">new</span> (ELeave) <a class="code" href="class_c_audio_stream_engine.html#47ab50a622df4dfac8b5e69d4fc17f43">CAudioStreamEngine</a>(aAppUi);
<a name="l00069"></a>00069         CleanupStack::PushL(<span class="keyword">self</span>);
<a name="l00070"></a>00070         <span class="keyword">self</span>-&gt;ConstructL();
<a name="l00071"></a>00071         <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00072"></a>00072         }
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="comment">// Standard EPOC 2nd phase constructor</span>
<a name="l00075"></a><a class="code" href="class_c_audio_stream_engine.html#9ce34ba0b947863222da3c63d0481044">00075</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#9ce34ba0b947863222da3c63d0481044">CAudioStreamEngine::ConstructL</a>()
<a name="l00076"></a>00076         {
<a name="l00077"></a>00077         <span class="comment">// Construct streams. We need to construct these here, so that at least the input stream</span>
<a name="l00078"></a>00078         <span class="comment">// exists if SetEncodingL() is called before any recording has taken place </span>
<a name="l00079"></a>00079         <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a> = CMdaAudioInputStream::NewL(*<span class="keyword">this</span>);
<a name="l00080"></a>00080         <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a> = CMdaAudioOutputStream::NewL(*<span class="keyword">this</span>);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <span class="comment">// Get a handle to the RFs session to be used (owned by CEikonEnv, NOT to be closed</span>
<a name="l00083"></a>00083         <span class="comment">// when this application exits!)                </span>
<a name="l00084"></a>00084         <a class="code" href="class_c_audio_stream_engine.html#7b548225db36c87401243f1080bbd0e8">iFs</a> = CEikonEnv::Static()-&gt;FsSession();
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <span class="comment">// Save the default encoding for later reference (the encoding is the same for</span>
<a name="l00087"></a>00087         <span class="comment">// both input and output streams).</span>
<a name="l00088"></a>00088         <a class="code" href="class_c_audio_stream_engine.html#79d29c1a5e50d8b53b64bb2ae8b85231">iDefaultEncoding</a> = <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;DataType();
<a name="l00089"></a>00089         <span class="comment">// At first we are using the default encoding.</span>
<a name="l00090"></a>00090         <a class="code" href="class_c_audio_stream_engine.html#4bae99e1d101cd0801b3f1110bcb4719">iCurrentEncoding</a> = <a class="code" href="class_c_audio_stream_engine.html#79d29c1a5e50d8b53b64bb2ae8b85231">iDefaultEncoding</a>;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment">// Stream buffer allocation (by default for PCM)</span>
<a name="l00093"></a>00093         <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a> = HBufC8::NewMaxL(<a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a> * <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a>);
<a name="l00094"></a>00094         <a class="code" href="class_c_audio_stream_engine.html#12c26d9ffd5bf641fff2e36e3d6772b4">iStreamStart</a>=0;
<a name="l00095"></a>00095         <a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a>=iFrameCount - 1;
<a name="l00096"></a>00096         
<a name="l00097"></a>00097 <span class="preprocessor">        #ifdef __SERIES60_3X__    </span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>        <span class="comment">// Only in 3rd Edition. The sample.aud/amr can be found in \private&lt;UID3&gt;\ folder.</span>
<a name="l00099"></a>00099         User::LeaveIfError( <a class="code" href="class_c_audio_stream_engine.html#7b548225db36c87401243f1080bbd0e8">iFs</a>.CreatePrivatePath( EDriveC ) );
<a name="l00100"></a>00100                 User::LeaveIfError( <a class="code" href="class_c_audio_stream_engine.html#7b548225db36c87401243f1080bbd0e8">iFs</a>.SetSessionToPrivate( EDriveC ) );
<a name="l00101"></a>00101         #<span class="keywordflow">else</span>
<a name="l00102"></a>00102                 #ifndef __WINS__  <span class="comment">// don't save settings to z-drive in emulator</span>
<a name="l00103"></a>00103                         <span class="comment">// In 2nd Ed device the sample.aud/amr will be in \system\apps\audiostream\ folder.</span>
<a name="l00104"></a>00104                 TFileName appFullName = <a class="code" href="class_c_audio_stream_engine.html#39e5bfebda301934fd58992621a51448">iAppUi</a>-&gt;Application()-&gt;AppFullName();
<a name="l00105"></a>00105                 TParsePtr appPath(appFullName);
<a name="l00106"></a>00106                 <a class="code" href="class_c_audio_stream_engine.html#ab908be235391d4d6b7fa9a4ed03ce8e">iAudioFilePath</a> = appPath.DriveAndPath();
<a name="l00107"></a>00107 <span class="preprocessor">                #else </span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>                        <span class="comment">// For 2nd Ed emulator</span>
<a name="l00109"></a>00109                         <a class="code" href="class_c_audio_stream_engine.html#ab908be235391d4d6b7fa9a4ed03ce8e">iAudioFilePath</a>.Append(KEmulatorPath);
<a name="l00110"></a>00110 <span class="preprocessor">                #endif //__WINS__</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>                
<a name="l00112"></a>00112 <span class="preprocessor">        #endif</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>        }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00116"></a>00116 <span class="comment">// CAudioStreamEngine::CAudioStreamEngine(</span>
<a name="l00117"></a>00117 <span class="comment">//     CAudioStreamAppUi* aAppUi)</span>
<a name="l00118"></a>00118 <span class="comment">//</span>
<a name="l00119"></a>00119 <span class="comment">// onstructor</span>
<a name="l00120"></a>00120 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00121"></a><a class="code" href="class_c_audio_stream_engine.html#47ab50a622df4dfac8b5e69d4fc17f43">00121</a> <a class="code" href="class_c_audio_stream_engine.html#47ab50a622df4dfac8b5e69d4fc17f43">CAudioStreamEngine::CAudioStreamEngine</a>(<a class="code" href="class_c_audio_stream_app_ui.html">CAudioStreamAppUi</a>* aAppUi)
<a name="l00122"></a>00122 : iAppUi(aAppUi), iUseAMR(EFalse), iAudioFile(KAudioFilePCM), iFrameSize(KFrameSizePCM), 
<a name="l00123"></a>00123 iFrameCount(KFrameCountPCM), iStreamBuffer(0), iFramePtr(0,0), iBufferOK(EFalse)
<a name="l00124"></a>00124         {
<a name="l00125"></a>00125         <span class="comment">// By default we use PCM and initialise the instance variables accordingly above.</span>
<a name="l00126"></a>00126                 
<a name="l00127"></a>00127         <span class="comment">// Initial audio stream properties for input and output, 8KHz mono. </span>
<a name="l00128"></a>00128         <span class="comment">// These settings could also be set/changed using method SetAudioPropertiesL() of</span>
<a name="l00129"></a>00129         <span class="comment">// the input and output streams.</span>
<a name="l00130"></a>00130         <a class="code" href="class_c_audio_stream_engine.html#d64e52d9e9018bec9700a36b8a7538ce">iStreamSettings</a>.iChannels=TMdaAudioDataSettings::EChannelsMono;
<a name="l00131"></a>00131         <a class="code" href="class_c_audio_stream_engine.html#d64e52d9e9018bec9700a36b8a7538ce">iStreamSettings</a>.iSampleRate=TMdaAudioDataSettings::ESampleRate8000Hz;
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00135"></a>00135 <span class="comment">// CAudioStreamEngine::~CAudioStreamEngine()</span>
<a name="l00136"></a>00136 <span class="comment">//</span>
<a name="l00137"></a>00137 <span class="comment">// destructor</span>
<a name="l00138"></a>00138 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00139"></a><a class="code" href="class_c_audio_stream_engine.html#d830b1f4ecf3fc3e9590a103bfd99c10">00139</a> <a class="code" href="class_c_audio_stream_engine.html#d830b1f4ecf3fc3e9590a103bfd99c10">CAudioStreamEngine::~CAudioStreamEngine</a>()
<a name="l00140"></a>00140         { 
<a name="l00141"></a>00141         <span class="comment">// close and delete streams</span>
<a name="l00142"></a>00142         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>)
<a name="l00143"></a>00143                 {
<a name="l00144"></a>00144                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a>!=ENotReady) <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;Stop();
<a name="l00145"></a>00145             <span class="keyword">delete</span> <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>;
<a name="l00146"></a>00146         <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>=NULL;
<a name="l00147"></a>00147                 }
<a name="l00148"></a>00148         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>)
<a name="l00149"></a>00149                 {
<a name="l00150"></a>00150                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a>!=ENotReady) <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;Stop();
<a name="l00151"></a>00151             <span class="keyword">delete</span> <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>;
<a name="l00152"></a>00152         <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>=NULL;
<a name="l00153"></a>00153                 }
<a name="l00154"></a>00154         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>)
<a name="l00155"></a>00155                 {
<a name="l00156"></a>00156                 <span class="keyword">delete</span> <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>;
<a name="l00157"></a>00157                 <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a> = NULL;
<a name="l00158"></a>00158                 }
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00163"></a>00163 <span class="comment">// CAudioStreamEngine::Play()</span>
<a name="l00164"></a>00164 <span class="comment">//</span>
<a name="l00165"></a>00165 <span class="comment">// plays the audio data contained in the buffer</span>
<a name="l00166"></a>00166 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00167"></a><a class="code" href="class_c_audio_stream_engine.html#80ce1ac02249eb8d64361940d6f4206a">00167</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#80ce1ac02249eb8d64361940d6f4206a">CAudioStreamEngine::Play</a>()
<a name="l00168"></a>00168         {
<a name="l00169"></a>00169         <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Play "</span>), ETrue);
<a name="l00170"></a>00170         <span class="comment">// if either stream is active, return</span>
<a name="l00171"></a>00171         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a>!=ENotReady || <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a>!=ENotReady) 
<a name="l00172"></a>00172                 {
<a name="l00173"></a>00173             <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Stream in use, \ncannot play audio."</span>), ETrue);
<a name="l00174"></a>00174                 <span class="keywordflow">return</span>;
<a name="l00175"></a>00175                 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         <span class="keywordflow">if</span>(!<a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a>)
<a name="l00178"></a>00178             {
<a name="l00179"></a>00179             <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Nothing to play - \nrecord or load \na file first."</span>), ETrue);
<a name="l00180"></a>00180             <span class="keywordflow">return</span>;
<a name="l00181"></a>00181             }
<a name="l00182"></a>00182                 
<a name="l00183"></a>00183         <span class="comment">// Open output stream.</span>
<a name="l00184"></a>00184         <span class="comment">// Upon completion will receive callback in </span>
<a name="l00185"></a>00185         <span class="comment">// MMdaAudioOutputStreamCallback::MaoscOpenComplete().</span>
<a name="l00186"></a>00186 <span class="preprocessor">        #ifndef __SERIES60_3X__  // Not 3rd Ed</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>                <span class="comment">// Some 2nd Edition, FP2 devices (such as Nokia 6630) require the stream to be</span>
<a name="l00188"></a>00188                 <span class="comment">// reconstructed each time before calling Open() - otherwise the callback</span>
<a name="l00189"></a>00189                 <span class="comment">// never gets called.</span>
<a name="l00190"></a>00190                 <span class="keywordflow">if</span> (iOutputStream) <span class="keyword">delete</span> iOutputStream;
<a name="l00191"></a>00191                 iOutputStream = NULL; <span class="comment">// In case the following NewL leaves</span>
<a name="l00192"></a>00192                 TRAPD(err, iOutputStream = CMdaAudioOutputStream::NewL(*<span class="keyword">this</span>));
<a name="l00193"></a>00193                 PanicIfError(err);
<a name="l00194"></a>00194 <span class="preprocessor">        #endif</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>        iOutputStream-&gt;Open(&amp;iStreamSettings);
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00200"></a>00200 <span class="comment">// CAudioStreamEngine::Record()</span>
<a name="l00201"></a>00201 <span class="comment">//</span>
<a name="l00202"></a>00202 <span class="comment">// records audio data into the buffer</span>
<a name="l00203"></a>00203 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00204"></a><a class="code" href="class_c_audio_stream_engine.html#0ed8b9a3b0b23104cc2f3bc72410fe8f">00204</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#0ed8b9a3b0b23104cc2f3bc72410fe8f">CAudioStreamEngine::Record</a>()
<a name="l00205"></a>00205         {
<a name="l00206"></a>00206         <span class="comment">// If either stream is active, return</span>
<a name="l00207"></a>00207         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a>!=ENotReady || <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a>!=ENotReady) 
<a name="l00208"></a>00208         {
<a name="l00209"></a>00209             <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Stream in use, \ncannot record audio."</span>), ETrue);
<a name="l00210"></a>00210                 <span class="keywordflow">return</span>;
<a name="l00211"></a>00211         }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <span class="comment">// Open input stream.</span>
<a name="l00214"></a>00214         <span class="comment">// Upon completion will receive callback in </span>
<a name="l00215"></a>00215         <span class="comment">// MMdaAudioInputStreamCallback::MaiscOpenComplete().</span>
<a name="l00216"></a>00216 <span class="preprocessor">        #ifndef __SERIES60_3X__  // Not 3rd Ed</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>                <span class="comment">// Some 2nd Edition, FP2 devices (such as Nokia 6630) require the stream to be</span>
<a name="l00218"></a>00218                 <span class="comment">// reconstructed each time before calling Open() - otherwise the callback</span>
<a name="l00219"></a>00219                 <span class="comment">// never gets called.</span>
<a name="l00220"></a>00220                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>) <span class="keyword">delete</span> <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>;
<a name="l00221"></a>00221                 <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a> = NULL; <span class="comment">// In case the following NewL leaves</span>
<a name="l00222"></a>00222                 TRAPD(err, <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a> = CMdaAudioInputStream::NewL(*<span class="keyword">this</span>));
<a name="l00223"></a>00223                 PanicIfError(err);
<a name="l00224"></a>00224 <span class="preprocessor">        #endif</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>        <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;Open(&amp;<a class="code" href="class_c_audio_stream_engine.html#d64e52d9e9018bec9700a36b8a7538ce">iStreamSettings</a>);
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00229"></a>00229 <span class="comment">// CAudioStreamEngine::Stop()</span>
<a name="l00230"></a>00230 <span class="comment">//</span>
<a name="l00231"></a>00231 <span class="comment">// stops playing/recording</span>
<a name="l00232"></a>00232 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00233"></a><a class="code" href="class_c_audio_stream_engine.html#78109ff8cb02d98ff75ab125fa94a8d4">00233</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#78109ff8cb02d98ff75ab125fa94a8d4">CAudioStreamEngine::Stop</a>()
<a name="l00234"></a>00234         {
<a name="l00235"></a>00235         <span class="comment">// if input or output streams are active, close them</span>
<a name="l00236"></a>00236         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a>!=ENotReady) 
<a name="l00237"></a>00237                 {
<a name="l00238"></a>00238                 <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;Stop();
<a name="l00239"></a>00239                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"\nRecording stopped!"</span>), EFalse);
<a name="l00240"></a>00240                 <a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a> = ETrue;
<a name="l00241"></a>00241                 }               
<a name="l00242"></a>00242         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a>!=ENotReady) 
<a name="l00243"></a>00243                 {
<a name="l00244"></a>00244                 <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;Stop();
<a name="l00245"></a>00245                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"\nPlayback stopped!"</span>), ETrue);
<a name="l00246"></a>00246                 }
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00251"></a>00251 <span class="comment">// CAudioStreamEngine::LoadAudioFileL()</span>
<a name="l00252"></a>00252 <span class="comment">//</span>
<a name="l00253"></a>00253 <span class="comment">// loads the audio data from a file into the buffer</span>
<a name="l00254"></a>00254 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00255"></a><a class="code" href="class_c_audio_stream_engine.html#32024e338b13f10f67e07562dc401ded">00255</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#32024e338b13f10f67e07562dc401ded">CAudioStreamEngine::LoadAudioFileL</a>()
<a name="l00256"></a>00256         {
<a name="l00257"></a>00257         RFileReadStream audiofile;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="comment">// open file</span>
<a name="l00260"></a>00260         TFileName fileName;
<a name="l00261"></a>00261         fileName.Copy(<a class="code" href="class_c_audio_stream_engine.html#ab908be235391d4d6b7fa9a4ed03ce8e">iAudioFilePath</a>);
<a name="l00262"></a>00262         fileName.Append(<a class="code" href="class_c_audio_stream_engine.html#ad169f34eaa35049936e6eb4fcd91a50">iAudioFile</a>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         TInt err = audiofile.Open(<a class="code" href="class_c_audio_stream_engine.html#7b548225db36c87401243f1080bbd0e8">iFs</a>, fileName, EFileRead|EFileStream);
<a name="l00265"></a>00265         <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>-&gt;Des().FillZ(<a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a> * <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>);  <span class="comment">// Empty the stream buffer</span>
<a name="l00266"></a>00266         <span class="keywordflow">if</span> (err==KErrNone) 
<a name="l00267"></a>00267                 {
<a name="l00268"></a>00268                 <span class="comment">// file opened ok, proceed reading</span>
<a name="l00269"></a>00269                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#00264adb1225a3268397a8612c883c17">iUseAMR</a>)
<a name="l00270"></a>00270                         {
<a name="l00271"></a>00271                         <span class="comment">// Read the AMR header (the first 6 bytes). We don't need to save/use the header,</span>
<a name="l00272"></a>00272                         <span class="comment">// since while playback we already know it's an AMR-NB encoded stream.</span>
<a name="l00273"></a>00273                         TBuf8&lt;KAMRHeaderLength&gt; temp;
<a name="l00274"></a>00274                         audiofile.ReadL(temp, KAMRHeaderLength);
<a name="l00275"></a>00275                         }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277                 TUint idx=0;
<a name="l00278"></a>00278                 <span class="keywordflow">while</span> (idx &lt; <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a>)
<a name="l00279"></a>00279                         {
<a name="l00280"></a>00280                         TRAPD(fstatus, audiofile.ReadL(<a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">GetFrame</a>(idx), iFrameSize));
<a name="l00281"></a>00281                         <span class="keywordflow">if</span> (fstatus!=KErrNone)
<a name="l00282"></a>00282                                 <span class="keywordflow">break</span>;
<a name="l00283"></a>00283                         idx++;
<a name="l00284"></a>00284                         }
<a name="l00285"></a>00285                 <a class="code" href="class_c_audio_stream_engine.html#12c26d9ffd5bf641fff2e36e3d6772b4">iStreamStart</a>=0;
<a name="l00286"></a>00286                 <a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a>=idx-1;
<a name="l00287"></a>00287                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Loading complete!"</span>), ETrue);
<a name="l00288"></a>00288                 <a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a> = ETrue;      
<a name="l00289"></a>00289                 }       
<a name="l00290"></a>00290         <span class="keywordflow">else</span> 
<a name="l00291"></a>00291                 {
<a name="l00292"></a>00292                 <span class="comment">// failed to open file</span>
<a name="l00293"></a>00293                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Error loading \naudio sample!"</span>), ETrue); 
<a name="l00294"></a>00294                 <a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a> = EFalse;
<a name="l00295"></a>00295                 }
<a name="l00296"></a>00296         audiofile.Close();
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00301"></a>00301 <span class="comment">// CAudioStreamEngine::SaveAudioFileL()</span>
<a name="l00302"></a>00302 <span class="comment">//</span>
<a name="l00303"></a>00303 <span class="comment">// saves the audio data in the buffer into a file</span>
<a name="l00304"></a>00304 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00305"></a><a class="code" href="class_c_audio_stream_engine.html#b476091c1562494b306469ee9fdd1507">00305</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#b476091c1562494b306469ee9fdd1507">CAudioStreamEngine::SaveAudioFileL</a>()
<a name="l00306"></a>00306         {
<a name="l00307"></a>00307         <span class="keywordflow">if</span> (!<a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a>)
<a name="l00308"></a>00308         {
<a name="l00309"></a>00309                 <span class="comment">// In case the encoding was changed between recording and trying to save the file</span>
<a name="l00310"></a>00310                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Recorded buffer does not \nmatch current encoding."</span>), ETrue);   
<a name="l00311"></a>00311                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"\nPlease re-record and \ntry again."</span>), EFalse); 
<a name="l00312"></a>00312                 <span class="keywordflow">return</span>;
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314         RFileWriteStream audiofile;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="comment">// Check for free space for saving the sample</span>
<a name="l00317"></a>00317         TVolumeInfo volinfo;
<a name="l00318"></a>00318         TInt err=<a class="code" href="class_c_audio_stream_engine.html#7b548225db36c87401243f1080bbd0e8">iFs</a>.Volume(volinfo,EDriveC);
<a name="l00319"></a>00319         <span class="keywordflow">if</span> ( volinfo.iFree&lt;(<a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a>*<a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>))
<a name="l00320"></a>00320                 {
<a name="l00321"></a>00321                 <span class="comment">// Not enough free space on drive for saving, report and exit</span>
<a name="l00322"></a>00322                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Cannot save file:\nnot enough space!"</span>), ETrue); 
<a name="l00323"></a>00323                 <span class="keywordflow">return</span>;
<a name="l00324"></a>00324                 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         TFileName fileName;
<a name="l00327"></a>00327         fileName.Copy(<a class="code" href="class_c_audio_stream_engine.html#ab908be235391d4d6b7fa9a4ed03ce8e">iAudioFilePath</a>);
<a name="l00328"></a>00328         fileName.Append(<a class="code" href="class_c_audio_stream_engine.html#ad169f34eaa35049936e6eb4fcd91a50">iAudioFile</a>);
<a name="l00329"></a>00329         err = audiofile.Replace(<a class="code" href="class_c_audio_stream_engine.html#7b548225db36c87401243f1080bbd0e8">iFs</a>, fileName, EFileWrite|EFileStream);
<a name="l00330"></a>00330         <span class="keywordflow">if</span> (err==KErrNone) 
<a name="l00331"></a>00331                 {
<a name="l00332"></a>00332                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#00264adb1225a3268397a8612c883c17">iUseAMR</a>)
<a name="l00333"></a>00333                         {
<a name="l00334"></a>00334                                 <span class="comment">// Write the six-byte AMR header, so that the file can be used by other</span>
<a name="l00335"></a>00335                                 <span class="comment">// applications as well.</span>
<a name="l00336"></a>00336                                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; KAMRHeaderLength; i++)
<a name="l00337"></a>00337                                         audiofile.WriteUint8L(KAMRNBHeader[i]);
<a name="l00338"></a>00338                         }
<a name="l00339"></a>00339                         
<a name="l00340"></a>00340                 <span class="comment">// File opened ok, proceed writing.</span>
<a name="l00341"></a>00341                 <span class="comment">// Write audio data directly from iStreamBuffer</span>
<a name="l00342"></a>00342                 <span class="keywordflow">for</span> (TUint idx=<a class="code" href="class_c_audio_stream_engine.html#12c26d9ffd5bf641fff2e36e3d6772b4">iStreamStart</a>; idx&lt;=<a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a>; idx++)<span class="comment">//iFrameCount; idx++)</span>
<a name="l00343"></a>00343                         {
<a name="l00344"></a>00344                         audiofile.WriteL(<a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">GetFrame</a>(idx));
<a name="l00345"></a>00345                         }
<a name="l00346"></a>00346                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Saving complete!"</span>), ETrue);     
<a name="l00347"></a>00347                 }       
<a name="l00348"></a>00348         <span class="keywordflow">else</span> 
<a name="l00349"></a>00349                 {
<a name="l00350"></a>00350                 <span class="comment">// failed to open file</span>
<a name="l00351"></a>00351                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Error saving \naudio sample!"</span>), ETrue); 
<a name="l00352"></a>00352                 }
<a name="l00353"></a>00353         audiofile.Close();
<a name="l00354"></a>00354         }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00357"></a>00357 <span class="comment">// CAudioStreamEngine::SetEncodingL(TBool aAmr)</span>
<a name="l00358"></a>00358 <span class="comment">//</span>
<a name="l00359"></a>00359 <span class="comment">// If argument is ETrue, AMR-NB encoding will be used in audio input/output.</span>
<a name="l00360"></a>00360 <span class="comment">// If EFalse, the default PCM is used. If the platform does not support AMR-NB,</span>
<a name="l00361"></a>00361 <span class="comment">// PCM will be used no matter what the argument's value is.</span>
<a name="l00362"></a>00362 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00363"></a><a class="code" href="class_c_audio_stream_engine.html#d5f95ec54752b45a80932269da6bcf8b">00363</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#d5f95ec54752b45a80932269da6bcf8b">CAudioStreamEngine::SetEncodingL</a>(TBool aAmr)
<a name="l00364"></a>00364         {
<a name="l00365"></a>00365         <span class="comment">// Act only if the new encoding differs from the current one</span>
<a name="l00366"></a>00366         <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#00264adb1225a3268397a8612c883c17">iUseAMR</a> != aAmr)
<a name="l00367"></a>00367                 {
<a name="l00368"></a>00368                 <a class="code" href="class_c_audio_stream_engine.html#00264adb1225a3268397a8612c883c17">iUseAMR</a> = aAmr;
<a name="l00369"></a>00369                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#00264adb1225a3268397a8612c883c17">iUseAMR</a>)
<a name="l00370"></a>00370                         {
<a name="l00371"></a>00371                         <span class="comment">// Try to set AMR-NB encoding, this will indicate whether it is supported</span>
<a name="l00372"></a>00372                         <span class="comment">// by the platform or not.</span>
<a name="l00373"></a>00373                         TRAPD(err, <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;SetDataTypeL(KMMFFourCCCodeAMR));
<a name="l00374"></a>00374                         <span class="keywordflow">if</span> (err != KErrNone)
<a name="l00375"></a>00375                                 {
<a name="l00376"></a>00376                                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"AMR-NB not supported,\nusing PCM."</span>), ETrue);    
<a name="l00377"></a>00377                                 <a class="code" href="class_c_audio_stream_engine.html#4bae99e1d101cd0801b3f1110bcb4719">iCurrentEncoding</a> = <a class="code" href="class_c_audio_stream_engine.html#79d29c1a5e50d8b53b64bb2ae8b85231">iDefaultEncoding</a>;
<a name="l00378"></a>00378                                 <a class="code" href="class_c_audio_stream_engine.html#00264adb1225a3268397a8612c883c17">iUseAMR</a> = EFalse;
<a name="l00379"></a>00379                                 <span class="comment">// We do not need to invalidate the buffer or change buffer settings, </span>
<a name="l00380"></a>00380                                 <span class="comment">// since the encoding was not changed -&gt; just return.</span>
<a name="l00381"></a>00381                                 <span class="keywordflow">return</span>;  
<a name="l00382"></a>00382                                 }
<a name="l00383"></a>00383                         <span class="keywordflow">else</span>
<a name="l00384"></a>00384                                 {
<a name="l00385"></a>00385                                 <a class="code" href="class_c_audio_stream_engine.html#4bae99e1d101cd0801b3f1110bcb4719">iCurrentEncoding</a> = KMMFFourCCCodeAMR;
<a name="l00386"></a>00386                                 <a class="code" href="class_c_audio_stream_engine.html#ad169f34eaa35049936e6eb4fcd91a50">iAudioFile</a>.Zero();  <span class="comment">// Empty the audio file name                                </span>
<a name="l00387"></a>00387                                 <a class="code" href="class_c_audio_stream_engine.html#ad169f34eaa35049936e6eb4fcd91a50">iAudioFile</a>.Append(KAudioFileAMR);
<a name="l00388"></a>00388                                 <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a> = KFrameCountAMR;
<a name="l00389"></a>00389                                 <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a> = KFrameSizeAMR;
<a name="l00390"></a>00390                                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Encoding set to AMR-NB."</span>), ETrue);      
<a name="l00391"></a>00391                                 }
<a name="l00392"></a>00392                         }
<a name="l00393"></a>00393                 <span class="keywordflow">else</span>
<a name="l00394"></a>00394                         {
<a name="l00395"></a>00395                         <span class="comment">// If we get here, the encoding has previously been changed to AMR. Switch back to</span>
<a name="l00396"></a>00396                         <span class="comment">// PCM.</span>
<a name="l00397"></a>00397                         <a class="code" href="class_c_audio_stream_engine.html#4bae99e1d101cd0801b3f1110bcb4719">iCurrentEncoding</a> = <a class="code" href="class_c_audio_stream_engine.html#79d29c1a5e50d8b53b64bb2ae8b85231">iDefaultEncoding</a>;
<a name="l00398"></a>00398                         <a class="code" href="class_c_audio_stream_engine.html#ad169f34eaa35049936e6eb4fcd91a50">iAudioFile</a>.Zero();  <span class="comment">// Empty the audio file name                                </span>
<a name="l00399"></a>00399                         <a class="code" href="class_c_audio_stream_engine.html#ad169f34eaa35049936e6eb4fcd91a50">iAudioFile</a>.Append(KAudioFilePCM);
<a name="l00400"></a>00400                         <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a> = KFrameCountPCM;
<a name="l00401"></a>00401                         <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a> = KFrameSizePCM;
<a name="l00402"></a>00402                         <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Encoding set to PCM."</span>), ETrue); 
<a name="l00403"></a>00403                         }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405                 <span class="comment">// Make sure the user re-records or reloads the audio file, so that we do not </span>
<a name="l00406"></a>00406                 <span class="comment">// accidentally try to play PCM data using AMR or vice versa.</span>
<a name="l00407"></a>00407                 <a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a> = EFalse;     
<a name="l00408"></a>00408                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>) <span class="keyword">delete</span> <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>;
<a name="l00409"></a>00409                 <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a> = NULL; <span class="comment">// In case the following NewL leaves</span>
<a name="l00410"></a>00410                 <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a> = HBufC8::NewMaxL(<a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a> * <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a>);
<a name="l00411"></a>00411                 <a class="code" href="class_c_audio_stream_engine.html#12c26d9ffd5bf641fff2e36e3d6772b4">iStreamStart</a>=0;
<a name="l00412"></a>00412                 <a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a>=iFrameCount - 1;
<a name="l00413"></a>00413                 }       
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00417"></a>00417 <span class="comment">// CAudioStreamEngine::ShowMessage(</span>
<a name="l00418"></a>00418 <span class="comment">//     const TDesC&amp; aMsg, TBool aReset=EFalse)</span>
<a name="l00419"></a>00419 <span class="comment">//</span>
<a name="l00420"></a>00420 <span class="comment">// displays text referenced by aMsg in the label, will append the aMsg in the </span>
<a name="l00421"></a>00421 <span class="comment">// existing text in label if aReset is EFalse, otherwise will reset the label </span>
<a name="l00422"></a>00422 <span class="comment">// text.</span>
<a name="l00423"></a>00423 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00424"></a><a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">00424</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">CAudioStreamEngine::ShowMessage</a>(<span class="keyword">const</span> TDesC&amp; aMsg, TBool aReset=EFalse)
<a name="l00425"></a>00425         {
<a name="l00426"></a>00426         <span class="keywordflow">if</span> (aReset)     <span class="comment">// if ETrue, clear the message on the label prior to output</span>
<a name="l00427"></a>00427                 <a class="code" href="class_c_audio_stream_engine.html#f8961fdb07547762c2b0bbb54151dbe1">iMsg</a>.Zero();
<a name="l00428"></a>00428         <a class="code" href="class_c_audio_stream_engine.html#f8961fdb07547762c2b0bbb54151dbe1">iMsg</a>.Append(aMsg);
<a name="l00429"></a>00429         TRAPD(error, <a class="code" href="class_c_audio_stream_engine.html#39e5bfebda301934fd58992621a51448">iAppUi</a>-&gt;<a class="code" href="class_c_audio_stream_app_ui.html#d1764f7dce24bff3d312268ead1ae0d3">GetView</a>()-&gt;<a class="code" href="class_c_audio_stream_view.html#bf13ca363d9672906d0680e7c9b80e79">ShowMessageL</a>(<a class="code" href="class_c_audio_stream_engine.html#f8961fdb07547762c2b0bbb54151dbe1">iMsg</a>));
<a name="l00430"></a>00430         PanicIfError(error);
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00434"></a>00434 <span class="comment">// TPtr8&amp; CAudioStreamEngine::GetFrame(TUint aFrameIdx)</span>
<a name="l00435"></a>00435 <span class="comment">//</span>
<a name="l00436"></a>00436 <span class="comment">// Returns a modifiable pointer to a single frame inside the audio buffer </span>
<a name="l00437"></a>00437 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00438"></a><a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">00438</a> TPtr8&amp; <a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">CAudioStreamEngine::GetFrame</a>(TUint aFrameIdx)
<a name="l00439"></a>00439         {
<a name="l00440"></a>00440           __ASSERT_ALWAYS(aFrameIdx &lt; <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a>, 
<a name="l00441"></a>00441                                                                         User::Panic(_L(<span class="stringliteral">"AudioStreamEx"</span>), 1));
<a name="l00442"></a>00442                                                                 
<a name="l00443"></a>00443           <a class="code" href="class_c_audio_stream_engine.html#8642d45997d72e5f70d4c4027914797b">iFramePtr</a>.Set((TUint8*)(<a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>-&gt;Ptr() + (aFrameIdx * <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>)),
<a name="l00444"></a>00444                                                                  <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>,
<a name="l00445"></a>00445                                                                  <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>);
<a name="l00446"></a>00446           <span class="keywordflow">return</span> <a class="code" href="class_c_audio_stream_engine.html#8642d45997d72e5f70d4c4027914797b">iFramePtr</a>;
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00450"></a>00450 <span class="comment">// TPtr8&amp; CAudioStreamEngine::GetPlaybackFrames(TUint aLastFrame)</span>
<a name="l00451"></a>00451 <span class="comment">//</span>
<a name="l00452"></a>00452 <span class="comment">// Returns a modifiable pointer to the requested frames inside the audio buffer</span>
<a name="l00453"></a>00453 <span class="comment">// (from the first frame to aLastFrame). </span>
<a name="l00454"></a>00454 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00455"></a><a class="code" href="class_c_audio_stream_engine.html#eca631dca2dad292f1ee503ef03d6e33">00455</a> TPtr8&amp; <a class="code" href="class_c_audio_stream_engine.html#eca631dca2dad292f1ee503ef03d6e33">CAudioStreamEngine::GetPlaybackFrames</a>(TUint aLastFrame)
<a name="l00456"></a>00456         {
<a name="l00457"></a>00457         __ASSERT_ALWAYS(aLastFrame &lt; <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a>, 
<a name="l00458"></a>00458                                                                 User::Panic(_L(<span class="stringliteral">"AudioStreamEx"</span>), 2));
<a name="l00459"></a>00459                                                                 
<a name="l00460"></a>00460         <a class="code" href="class_c_audio_stream_engine.html#8642d45997d72e5f70d4c4027914797b">iFramePtr</a>.Set((TUint8*)(<a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>-&gt;Ptr()),
<a name="l00461"></a>00461                                                                  (aLastFrame + 1) * <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>,
<a name="l00462"></a>00462                                                                  (aLastFrame + 1) * <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>);
<a name="l00463"></a>00463         <span class="keywordflow">return</span> <a class="code" href="class_c_audio_stream_engine.html#8642d45997d72e5f70d4c4027914797b">iFramePtr</a>;
<a name="l00464"></a>00464         }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 <span class="comment">//</span>
<a name="l00468"></a>00468 <span class="comment">// MMdaAudioInputStream callbacks (MMdaAudioInputStreamCallback)</span>
<a name="l00469"></a>00469 <span class="comment">//</span>
<a name="l00470"></a>00470 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00471"></a>00471 <span class="comment">// CAudioStreamEngine::MaiscOpenComplete(</span>
<a name="l00472"></a>00472 <span class="comment">//     TInt aError)</span>
<a name="l00473"></a>00473 <span class="comment">//</span>
<a name="l00474"></a>00474 <span class="comment">// called upon completion of CMdaAudioInputStream::Open(),</span>
<a name="l00475"></a>00475 <span class="comment">// if the stream was opened succesfully (aError==KErrNone), it's ready for use.</span>
<a name="l00476"></a>00476 <span class="comment">// upon succesful open, the first audio data block will be read from the input</span>
<a name="l00477"></a>00477 <span class="comment">// stream.</span>
<a name="l00478"></a>00478 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00479"></a><a class="code" href="class_c_audio_stream_engine.html#7860395c6a068eee730aea987f79e271">00479</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#7860395c6a068eee730aea987f79e271">CAudioStreamEngine::MaiscOpenComplete</a>(TInt aError)
<a name="l00480"></a>00480         {
<a name="l00481"></a>00481         <span class="keywordflow">if</span> (aError==KErrNone) 
<a name="l00482"></a>00482                 {
<a name="l00483"></a>00483                 <span class="comment">// Input stream opened succesfully, set status</span>
<a name="l00484"></a>00484                 <a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a> = EOpen;
<a name="l00485"></a>00485                 <span class="comment">// Set the data type (encoding)</span>
<a name="l00486"></a>00486                 TRAPD(error, <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;SetDataTypeL(<a class="code" href="class_c_audio_stream_engine.html#4bae99e1d101cd0801b3f1110bcb4719">iCurrentEncoding</a>));
<a name="l00487"></a>00487                 PanicIfError(error);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489                 <span class="comment">// set stream input gain to maximum</span>
<a name="l00490"></a>00490                 <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;SetGain(<a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;MaxGain()); 
<a name="l00491"></a>00491                 <span class="comment">// set stream priority to normal and time sensitive</span>
<a name="l00492"></a>00492                 <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;SetPriority(EPriorityNormal, EMdaPriorityPreferenceTime);                         
<a name="l00493"></a>00493                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Recording..."</span>), ETrue);
<a name="l00494"></a>00494                 
<a name="l00495"></a>00495                 <span class="comment">// Emtpy the buffer and issue ReadL() to read the first audio data block, </span>
<a name="l00496"></a>00496                 <span class="comment">// subsequent calls to ReadL() will be issued </span>
<a name="l00497"></a>00497                 <span class="comment">// in MMdaAudioInputStreamCallback::MaiscBufferCopied()</span>
<a name="l00498"></a>00498                 <a class="code" href="class_c_audio_stream_engine.html#669120c82a1438ff2a2a97830a8b6167">iStreamBuffer</a>-&gt;Des().FillZ(<a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a> * <a class="code" href="class_c_audio_stream_engine.html#7241a37e72d471b2b09dcfc0321874d8">iFrameSize</a>);
<a name="l00499"></a>00499                 <a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>=0;
<a name="l00500"></a>00500                 TRAPD(error2, <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;ReadL(<a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">GetFrame</a>(<a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>)));
<a name="l00501"></a>00501                 PanicIfError(error2);
<a name="l00502"></a>00502                 } 
<a name="l00503"></a>00503         <span class="keywordflow">else</span> 
<a name="l00504"></a>00504                 {
<a name="l00505"></a>00505                 <span class="comment">// input stream open failed</span>
<a name="l00506"></a>00506                 <a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a> = ENotReady;
<a name="l00507"></a>00507                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Recording failed!"</span>), ETrue);
<a name="l00508"></a>00508                 }
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00512"></a>00512 <span class="comment">// CAudioStreamEngine::MaiscBufferCopied(</span>
<a name="l00513"></a>00513 <span class="comment">//     TInt aError, const TDesC8&amp; aBuffer)</span>
<a name="l00514"></a>00514 <span class="comment">//</span>
<a name="l00515"></a>00515 <span class="comment">// called when a block of audio data has been read and is available at the </span>
<a name="l00516"></a>00516 <span class="comment">// buffer reference *aBuffer.  calls to ReadL() will be issued until all blocks</span>
<a name="l00517"></a>00517 <span class="comment">// in the audio data buffer (iStreamBuffer) are filled.</span>
<a name="l00518"></a>00518 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00519"></a><a class="code" href="class_c_audio_stream_engine.html#0061513b928e2aeadbe9b96d04ea25b0">00519</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#0061513b928e2aeadbe9b96d04ea25b0">CAudioStreamEngine::MaiscBufferCopied</a>(TInt aError, <span class="keyword">const</span> TDesC8&amp; <span class="comment">/*aBuffer*/</span>)
<a name="l00520"></a>00520         {
<a name="l00521"></a>00521         
<a name="l00522"></a>00522         <span class="keywordflow">if</span> (aError==KErrNone) 
<a name="l00523"></a>00523                 {
<a name="l00524"></a>00524                 <span class="comment">// stop recording if at the end of the buffer</span>
<a name="l00525"></a>00525                 <a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>++;
<a name="l00526"></a>00526                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a> == <a class="code" href="class_c_audio_stream_engine.html#0369cc9e697822334b3ae32032b24c22">iFrameCount</a>)
<a name="l00527"></a>00527                     {
<a name="l00528"></a>00528                     <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"\nRecording complete!"</span>), EFalse);
<a name="l00529"></a>00529                     <a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a> = <a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a> - 1;
<a name="l00530"></a>00530                 <a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a> = ETrue;
<a name="l00531"></a>00531                         <a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a> = ENotReady;
<a name="l00532"></a>00532                         <span class="comment">// NOTE: In 2nd Edition we MUST NOT call iInputStream-&gt;Stop() here, because</span>
<a name="l00533"></a>00533                         <span class="comment">// this will cause a crash on 2nd Edition, FP1 devices.</span>
<a name="l00534"></a>00534                         <span class="comment">// Since iInputStream-&gt;Stop() is not called, the callback method</span>
<a name="l00535"></a>00535                         <span class="comment">// MaiscRecordComplete() will not be called either after exiting this method.</span>
<a name="l00536"></a>00536                         <span class="comment">// In 3rd Edition, however, iInputStream-&gt;Stop() MUST be called in order to reach</span>
<a name="l00537"></a>00537                         <span class="comment">// MaiscRecordComplete(), otherwise the stream will "hang".</span>
<a name="l00538"></a>00538 <span class="preprocessor">                        #ifdef __SERIES60_3X__</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>                                <span class="comment">// It appears that in 3.2 also calling Stop() here causes crash.</span>
<a name="l00540"></a>00540                                 <span class="comment">// Instead we let MMF to detect that buffer becomes full. It will</span>
<a name="l00541"></a>00541                                 <span class="comment">// then call MaiscRecordComplete() with status KErrOverflow.</span>
<a name="l00542"></a>00542                                 <span class="comment">// Input stream will be stopped there.</span>
<a name="l00543"></a>00543 
<a name="l00544"></a>00544                                 <span class="comment">// iInputStream-&gt;Stop();</span>
<a name="l00545"></a>00545 <span class="preprocessor">                        #endif</span>
<a name="l00546"></a>00546 <span class="preprocessor"></span>                    <span class="keywordflow">return</span>;
<a name="l00547"></a>00547                         }               
<a name="l00548"></a>00548                 
<a name="l00549"></a>00549                 <span class="comment">// issue ReadL() for next frame         </span>
<a name="l00550"></a>00550                 TRAPD(error, <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;ReadL(<a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">GetFrame</a>(<a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>)));
<a name="l00551"></a>00551                 PanicIfError(error);
<a name="l00552"></a>00552                 }
<a name="l00553"></a>00553         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (aError==KErrAbort) 
<a name="l00554"></a>00554                 {
<a name="l00555"></a>00555                 <span class="comment">// Recording was aborted, due to call to CMdaAudioInputStream::Stop()</span>
<a name="l00556"></a>00556                 <span class="comment">// This KErrAbort will occur each time the Stop() method in this class is executed.</span>
<a name="l00557"></a>00557                 <span class="comment">// Also, MaiscRecordComplete() will be called after exiting this method.</span>
<a name="l00558"></a>00558             <a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a> = <a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a> - 1;
<a name="l00559"></a>00559             <a class="code" href="class_c_audio_stream_engine.html#84464ed96adf0b2245a30bb363c3558c">iBufferOK</a> = ETrue;
<a name="l00560"></a>00560                 <a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a> = ENotReady;
<a name="l00561"></a>00561                 }
<a name="l00562"></a>00562         <span class="keywordflow">else</span> 
<a name="l00563"></a>00563                 {
<a name="l00564"></a>00564                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"\nError reading data \nfrom input"</span>), EFalse);
<a name="l00565"></a>00565                 <a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a> = ENotReady;
<a name="l00566"></a>00566                 }
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00570"></a>00570 <span class="comment">// CAudioStreamEngine::MaiscRecordComplete(</span>
<a name="l00571"></a>00571 <span class="comment">//     TInt aError)</span>
<a name="l00572"></a>00572 <span class="comment">//</span>
<a name="l00573"></a>00573 <span class="comment">// called when input stream is closed by CMdaAudioInputStream::Stop()</span>
<a name="l00574"></a>00574 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00575"></a><a class="code" href="class_c_audio_stream_engine.html#3f44f895684f29284631f4faac6c7a38">00575</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#3f44f895684f29284631f4faac6c7a38">CAudioStreamEngine::MaiscRecordComplete</a>(TInt aError)
<a name="l00576"></a>00576         {       
<a name="l00577"></a>00577         <a class="code" href="class_c_audio_stream_engine.html#2977940d24b851e4f93aa2787e1b4903">iInputStatus</a> = ENotReady;
<a name="l00578"></a>00578         <span class="keywordflow">if</span> (aError==KErrNone) 
<a name="l00579"></a>00579                 {
<a name="l00580"></a>00580                 <span class="comment">// normal stream closure</span>
<a name="l00581"></a>00581                 }
<a name="l00582"></a>00582         <span class="keywordflow">else</span> 
<a name="l00583"></a>00583                 {
<a name="l00584"></a>00584                 <span class="comment">// completed with error(s)</span>
<a name="l00585"></a>00585                 }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="comment">// see comments in MaiscBufferCopied() regarding stopping the stream.</span>
<a name="l00588"></a>00588     <a class="code" href="class_c_audio_stream_engine.html#c89e68fb1f31a3ef3b5d6225ef952ac1">iInputStream</a>-&gt;Stop();
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 <span class="comment">// MMdaAudioOutputStream callbacks (MMdaAudioOutputStreamCallback)</span>
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00595"></a>00595 <span class="comment">// CAudioStreamEngine::MaoscOpenComplete(</span>
<a name="l00596"></a>00596 <span class="comment">//     TInt aError)</span>
<a name="l00597"></a>00597 <span class="comment">//</span>
<a name="l00598"></a>00598 <span class="comment">// called upon completion of CMdaAudioOutputStream::Open(),</span>
<a name="l00599"></a>00599 <span class="comment">// if the stream was opened succesfully (aError==KErrNone), it's ready for use.</span>
<a name="l00600"></a>00600 <span class="comment">// upon succesful open, the first audio data block will be written to the </span>
<a name="l00601"></a>00601 <span class="comment">// output stream.</span>
<a name="l00602"></a>00602 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00603"></a><a class="code" href="class_c_audio_stream_engine.html#d954b004e833f688ccc4d53622276bc3">00603</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#d954b004e833f688ccc4d53622276bc3">CAudioStreamEngine::MaoscOpenComplete</a>(TInt aError)
<a name="l00604"></a>00604         {
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (aError==KErrNone) 
<a name="l00606"></a>00606                 {
<a name="l00607"></a>00607                 <span class="comment">// output stream opened succesfully, set status</span>
<a name="l00608"></a>00608                 <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a> = EOpen;
<a name="l00609"></a>00609                 <span class="comment">// Set the data type (encoding). Should not fail, since we already</span>
<a name="l00610"></a>00610                 <span class="comment">// have tested support for this encoding in SetEncodingL with the </span>
<a name="l00611"></a>00611                 <span class="comment">// corresponding input stream!</span>
<a name="l00612"></a>00612                 TRAPD(error, <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;SetDataTypeL(<a class="code" href="class_c_audio_stream_engine.html#4bae99e1d101cd0801b3f1110bcb4719">iCurrentEncoding</a>));
<a name="l00613"></a>00613                 PanicIfError(error);
<a name="l00614"></a>00614                 
<a name="l00615"></a>00615                 <span class="comment">// set volume to 1/4th of stream max volume</span>
<a name="l00616"></a>00616                 <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;SetVolume(<a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;MaxVolume()/4);
<a name="l00617"></a>00617                 <span class="comment">// set stream priority to normal and time sensitive</span>
<a name="l00618"></a>00618                 <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;SetPriority(EPriorityNormal, 
<a name="l00619"></a>00619                         EMdaPriorityPreferenceTime);                            
<a name="l00620"></a>00620                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Playing "</span>), ETrue);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#00264adb1225a3268397a8612c883c17">iUseAMR</a>)
<a name="l00623"></a>00623                         {
<a name="l00624"></a>00624                         <span class="comment">// In case of AMR, the whole recorded/loaded buffer is played back at once, not frame by frame. </span>
<a name="l00625"></a>00625                         <span class="comment">// The buffer might not be fully recorded, so we will only play back the part</span>
<a name="l00626"></a>00626                         <span class="comment">// that is filled with data.</span>
<a name="l00627"></a>00627                         <a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a> = <a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a>;
<a name="l00628"></a>00628                         TRAPD(error2, <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;WriteL(<a class="code" href="class_c_audio_stream_engine.html#eca631dca2dad292f1ee503ef03d6e33">GetPlaybackFrames</a>(<a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a>)));
<a name="l00629"></a>00629                         PanicIfError(error2);
<a name="l00630"></a>00630                         }
<a name="l00631"></a>00631                 <span class="keywordflow">else</span>
<a name="l00632"></a>00632                         {
<a name="l00633"></a>00633                         <span class="comment">// PCM needs to be played back frame by frame, otherwise some older devices might</span>
<a name="l00634"></a>00634                         <span class="comment">// run into buffer overflow situations.</span>
<a name="l00635"></a>00635                         <a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a> = 0;
<a name="l00636"></a>00636                         TRAPD(error3, <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;WriteL(<a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">GetFrame</a>(<a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>)));
<a name="l00637"></a>00637                         PanicIfError(error3);
<a name="l00638"></a>00638                         }
<a name="l00639"></a>00639                 }
<a name="l00640"></a>00640         <span class="keywordflow">else</span> 
<a name="l00641"></a>00641                 {
<a name="l00642"></a>00642                 <span class="comment">// output stream open failed</span>
<a name="l00643"></a>00643                 <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a> = ENotReady;
<a name="l00644"></a>00644                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"Playback failed!"</span>), ETrue);
<a name="l00645"></a>00645                 }               
<a name="l00646"></a>00646         }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00649"></a>00649 <span class="comment">// CAudioStreamEngine::MaoscBufferCopied(</span>
<a name="l00650"></a>00650 <span class="comment">//     TInt aError, const TDesC8&amp; aBuffer)</span>
<a name="l00651"></a>00651 <span class="comment">//</span>
<a name="l00652"></a>00652 <span class="comment">// called when a block of audio data has been written to MMF. calls to WriteL() </span>
<a name="l00653"></a>00653 <span class="comment">// will be issued until all blocks in the audio data buffer (iStreamBuffer) are </span>
<a name="l00654"></a>00654 <span class="comment">// written.</span>
<a name="l00655"></a>00655 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00656"></a><a class="code" href="class_c_audio_stream_engine.html#02fc2ce62f96be691e899ba83ed13986">00656</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#02fc2ce62f96be691e899ba83ed13986">CAudioStreamEngine::MaoscBufferCopied</a>(TInt aError, <span class="keyword">const</span> TDesC8&amp; <span class="comment">/*aBuffer*/</span>)
<a name="l00657"></a>00657         {       
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (aError==KErrNone) 
<a name="l00659"></a>00659                 {
<a name="l00660"></a>00660                 <span class="keywordflow">if</span> (<a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>==<a class="code" href="class_c_audio_stream_engine.html#45bc1a13231cd5a8ac9888e4186f97dd">iStreamEnd</a>)
<a name="l00661"></a>00661                         {
<a name="l00662"></a>00662                         <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"\nPlayback complete!"</span>), EFalse);
<a name="l00663"></a>00663                         <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a> = ENotReady;
<a name="l00664"></a>00664                         <span class="comment">// NOTE: In 2nd Edition we MUST NOT call iOutputStream-&gt;Stop() here, because</span>
<a name="l00665"></a>00665                         <span class="comment">// this will cause a crash on 2nd Edition, FP1 devices.</span>
<a name="l00666"></a>00666                         <span class="comment">// Since iOutputStream-&gt;Stop() is not called, the callback method</span>
<a name="l00667"></a>00667                         <span class="comment">// MaiscRecordComplete() will not be called either after exiting this method.</span>
<a name="l00668"></a>00668                         <span class="comment">// In 3rd Edition, however, iOutputStream-&gt;Stop() MUST be called in order to reach</span>
<a name="l00669"></a>00669                         <span class="comment">// MaiscRecordComplete(), otherwise the stream will "hang".</span>
<a name="l00670"></a>00670 <span class="preprocessor">                        #ifdef __SERIES60_3X__</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span>                                <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;Stop();
<a name="l00672"></a>00672 <span class="preprocessor">                        #endif</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span>                        }
<a name="l00674"></a>00674                 <span class="keywordflow">else</span> 
<a name="l00675"></a>00675                         {
<a name="l00676"></a>00676                         <a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>++;
<a name="l00677"></a>00677                         TRAPD(error, <a class="code" href="class_c_audio_stream_engine.html#d1c60314bcb2353fe912efc6dda545b6">iOutputStream</a>-&gt;WriteL(<a class="code" href="class_c_audio_stream_engine.html#0f1e8c575f2717623061a5bc21bfc1e6">GetFrame</a>(<a class="code" href="class_c_audio_stream_engine.html#5313a2b7b35270d9b46db6b323e2dbba">iStreamIdx</a>)));      
<a name="l00678"></a>00678                         PanicIfError(error);
<a name="l00679"></a>00679                         }
<a name="l00680"></a>00680                 }
<a name="l00681"></a>00681         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (aError==KErrAbort) 
<a name="l00682"></a>00682                 {
<a name="l00683"></a>00683                 <span class="comment">// Playing was aborted, due to call to CMdaAudioOutputStream::Stop().</span>
<a name="l00684"></a>00684                 <span class="comment">// MaoscRecordComplete() will be called after exiting this method.</span>
<a name="l00685"></a>00685                 <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a> = ENotReady;
<a name="l00686"></a>00686                 }
<a name="l00687"></a>00687         <span class="keywordflow">else</span> 
<a name="l00688"></a>00688                 {
<a name="l00689"></a>00689                 <a class="code" href="class_c_audio_stream_engine.html#d602c940c042d4e7f9d615684b5470a1">ShowMessage</a>(_L(<span class="stringliteral">"\nError writing data \nto output"</span>), EFalse);                    
<a name="l00690"></a>00690                 <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a> = ENotReady;
<a name="l00691"></a>00691                 }
<a name="l00692"></a>00692         }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 
<a name="l00695"></a>00695 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00696"></a>00696 <span class="comment">// CAudioStreamEngine::MaoscPlayComplete(</span>
<a name="l00697"></a>00697 <span class="comment">//     TInt aError)</span>
<a name="l00698"></a>00698 <span class="comment">//</span>
<a name="l00699"></a>00699 <span class="comment">// called when output stream is closed by CMdaAudioOutputStream::Stop() or if </span>
<a name="l00700"></a>00700 <span class="comment">// end of audio data has been reached, in this case KErrUnderflow will be </span>
<a name="l00701"></a>00701 <span class="comment">// returned.</span>
<a name="l00702"></a>00702 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00703"></a><a class="code" href="class_c_audio_stream_engine.html#390831d5030b47e70fe2e10b24a31a61">00703</a> <span class="keywordtype">void</span> <a class="code" href="class_c_audio_stream_engine.html#390831d5030b47e70fe2e10b24a31a61">CAudioStreamEngine::MaoscPlayComplete</a>(TInt aError)
<a name="l00704"></a>00704         {
<a name="l00705"></a>00705         <a class="code" href="class_c_audio_stream_engine.html#fea23c3cb899347231962c82e379288d">iOutputStatus</a> = ENotReady;
<a name="l00706"></a>00706         <span class="keywordflow">if</span> (aError==KErrNone) 
<a name="l00707"></a>00707                 {
<a name="l00708"></a>00708                 <span class="comment">// normal stream closure</span>
<a name="l00709"></a>00709                 }       
<a name="l00710"></a>00710         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (aError==KErrUnderflow) 
<a name="l00711"></a>00711                 {
<a name="l00712"></a>00712                 <span class="comment">// end of audio data stream was reached because of stream underflow,</span>
<a name="l00713"></a>00713                 }
<a name="l00714"></a>00714         <span class="keywordflow">else</span> 
<a name="l00715"></a>00715                 {
<a name="l00716"></a>00716                 <span class="comment">// completed with error(s)</span>
<a name="l00717"></a>00717                 }       
<a name="l00718"></a>00718         }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 <span class="comment">// END OF FILE</span>
<a name="l00721"></a>00721 
</pre></div><hr>

<table x-use-null-cells
		style="x-cell-content-align: top;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;"
		cellspacing=0
		width=100%>
  <col style="width: 50%;">
  <col style="width: 50%;">

  <tr style="x-cell-content-align: top;"
	valign=top>
  <td style="width: 50%;
			padding-right: 10px;
			padding-left: 10px;
			border-right-style: None;
			border-left-style: None;
			border-top-style: None;
			border-bottom-style: None;"
	width=50%>
  <p style="font-family: Arial;"><small style="font-size: smaller;"> Nokia 2009</small></td>
  <td style="width: 50%;
			padding-right: 10px;
			padding-left: 10px;
			border-top-style: None;
			border-bottom-style: None;
			border-right-style: None;"
	width=50%>
  <p style="text-align: right; margin-right: -4px;"
	align=right><span style="font-weight: bold;"><a href="#Top"
													title="Back to top"><img
 src="top.gif"
	x-maintain-ratio=TRUE
	alt="Back to top"
	style="border: none;
			width: 18px;
			height: 15px;
			float: none;
			border-style: none;
			border-style: none;"
	width=18
	height=15
	border=0></a></span></td></tr>
 </table>
</body>
</html>

